#include <linux/init.h>
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/fb.h>
#include <linux/mm.h>

#define WIDTH 640
#define HEIGHT 480

static const uint16_t vgapalette[] __attribute__((aligned(16))) = {
0x0000, 0x000A, 0x00A0, 0x00AA, 0x0A00, 0x0A0A, 0x0A50, 0x0AAA,
0x0555, 0x055F, 0x05F5, 0x05FF, 0x0F55, 0x0F5F, 0x0FF5, 0x0FFF,
0x0000, 0x0111, 0x0222, 0x0333, 0x0444, 0x0555, 0x0666, 0x0777,
0x0888, 0x0999, 0x0AAA, 0x0BBB, 0x0CCC, 0x0DDD, 0x0EEE, 0x0FFF,
0x000F, 0x040F, 0x080F, 0x0B0F, 0x0F0F, 0x0F0B, 0x0F08, 0x0F04,
0x0F00, 0x0F40, 0x0F80, 0x0FB0, 0x0FF0, 0x0BF0, 0x08F0, 0x04F0,
0x00F0, 0x00F4, 0x00F8, 0x00FB, 0x00FF, 0x00BF, 0x008F, 0x004F,
0x088F, 0x098F, 0x0B8F, 0x0D8F, 0x0F8F, 0x0F8D, 0x0F8B, 0x0F89,
0x0F88, 0x0F98, 0x0FB8, 0x0FD8, 0x0FF8, 0x0DF8, 0x0BF8, 0x09F8,
0x08F8, 0x08F9, 0x08FB, 0x08FD, 0x08FF, 0x08DF, 0x08BF, 0x089F,
0x0BBF, 0x0CBF, 0x0DBF, 0x0EBF, 0x0FBF, 0x0FBE, 0x0FBD, 0x0FBC,
0x0FBB, 0x0FCB, 0x0FDB, 0x0FEB, 0x0FFB, 0x0EFB, 0x0DFB, 0x0CFB,
0x0BFB, 0x0BFC, 0x0BFD, 0x0BFE, 0x0BFF, 0x0BEF, 0x0BDF, 0x0BCF,
0x0007, 0x0107, 0x0307, 0x0507, 0x0707, 0x0705, 0x0703, 0x0701,
0x0700, 0x0710, 0x0730, 0x0750, 0x0770, 0x0570, 0x0370, 0x0170,
0x0070, 0x0071, 0x0073, 0x0075, 0x0077, 0x0057, 0x0037, 0x0017,
0x0337, 0x0437, 0x0537, 0x0637, 0x0737, 0x0736, 0x0735, 0x0734,
0x0733, 0x0743, 0x0753, 0x0763, 0x0773, 0x0673, 0x0573, 0x0473,
0x0373, 0x0374, 0x0375, 0x0376, 0x0377, 0x0367, 0x0357, 0x0347,
0x0557, 0x0557, 0x0657, 0x0657, 0x0757, 0x0756, 0x0756, 0x0755,
0x0755, 0x0755, 0x0765, 0x0765, 0x0775, 0x0675, 0x0675, 0x0575,
0x0575, 0x0575, 0x0576, 0x0576, 0x0577, 0x0567, 0x0567, 0x0557,
0x0004, 0x0104, 0x0204, 0x0304, 0x0404, 0x0403, 0x0402, 0x0401,
0x0400, 0x0410, 0x0420, 0x0430, 0x0440, 0x0340, 0x0240, 0x0140,
0x0040, 0x0041, 0x0042, 0x0043, 0x0044, 0x0034, 0x0024, 0x0014,
0x0224, 0x0224, 0x0324, 0x0324, 0x0424, 0x0423, 0x0423, 0x0422,
0x0422, 0x0422, 0x0432, 0x0432, 0x0442, 0x0342, 0x0342, 0x0242,
0x0242, 0x0242, 0x0243, 0x0243, 0x0244, 0x0234, 0x0234, 0x0224,
0x0224, 0x0324, 0x0324, 0x0324, 0x0424, 0x0423, 0x0423, 0x0423,
0x0422, 0x0432, 0x0432, 0x0432, 0x0442, 0x0342, 0x0342, 0x0342,
0x0242, 0x0243, 0x0243, 0x0243, 0x0244, 0x0234, 0x0234, 0x0234,
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000 };

static void op_fillrect(struct fb_info * info, const struct fb_fillrect * rect) {
    printk(KERN_ALERT "fillrect\n");
}

static void op_copyarea(struct fb_info * info, const struct fb_copyarea * area) {
    printk(KERN_ALERT "copyarea\n");
}

static void op_imageblit(struct fb_info * info, const struct fb_image * image) {
    printk(KERN_ALERT "imageblit\n");
}

static struct fb_info * info;

static struct fb_ops ops = {
    .owner = THIS_MODULE,
    //.fb_open = sandpiperfb_open,
    //.fb_release = sandpiperfb_release,
    .fb_fillrect = op_fillrect,
    .fb_copyarea = op_copyarea,
    .fb_imageblit = op_imageblit,
};

static const struct fb_fix_screeninfo fix = {
    .id = "sandpiperfb",
    .smem_start = 0x18000000, // Top of reserved memory, physical address
    .smem_len = 640 * 480, // 640x480x8bpp
    .type = FB_TYPE_PACKED_PIXELS,
    .visual = FB_VISUAL_PSEUDOCOLOR,
    .line_length = 640, // Stride is a multiple of 128
};

static const struct fb_var_screeninfo var = {
    .xres = WIDTH,
    .yres = HEIGHT,
    .xres_virtual = WIDTH,
    .yres_virtual = HEIGHT,
    .bits_per_pixel = 8,
    .height = HEIGHT,
    .width = WIDTH,
    .vmode = FB_VMODE_NONINTERLACED,
    .red = { .length = 8, .offset = 0, },
    .green = { .length = 8, .offset = 0, },
    .blue = { .length = 8, .offset = 0, }
};

static int mod_init(void)
{
    int err;
    info = framebuffer_alloc(0, 0);
    if (!info)
		return -1;
    info->fbops = &ops;
    info->fix = fix;
	info->pseudo_palette = vgapalette;
    info->var = var;
    info->screen_base = ioremap(fix.smem_start, 640 * 480);
    err = fb_alloc_cmap(&info->cmap, 256, 0);
    if (err < 0) return -2;
    err = register_framebuffer(info);
    if (err < 0) return -3;
    return 0;
}

static void mod_exit(void)
{
    return;
}

module_init(mod_init);
module_exit(mod_exit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Engin Cilasun");
MODULE_DESCRIPTION("sandpiper framebuffer driver");
